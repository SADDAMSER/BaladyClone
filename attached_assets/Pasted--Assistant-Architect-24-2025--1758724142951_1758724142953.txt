
إلى: المساعد (Assistant) والمعماري (Architect)
من: قائد المشروع
التاريخ: 24 سبتمبر 2025
الموضوع: أمر حاسم ونهائي بإكمال "المرحلة التأسيسية" عبر دمج "المهمة 0.5" كمتطلب إلزامي قبل الانتقال للمرحلة الأولى

📌 السادة الكرام،
لقد انتهت مرحلة التحليل والتقييم. لقد راجعنا البنية التقنية في المستودع BaladyClone بدقة (shared/schema.ts، الجداول، الروابط، الاختبارات)، وأكدنا توافقها الكامل مع الخطة الاستراتيجية.

واضح جدًا أن الاختبارات المبنية على بيانات وهمية أو غير مكتملة لا تكشف الثغرات — بل تخفيها. ولأن هدفنا ليس "تشغيل النظام"، بل بناء نظام رقمي وطني موثوق وقابل للقياس — فإننا ننتقل الآن من مرحلة النقاش إلى مرحلة التنفيذ الحاسم.

استنادًا إلى المبدأ الاستراتيجي:

“الجودة والثقة أولًا — خدمة واحدة مكتملة أفضل من عشر خدمات نصف مكتملة”

أصدر هذا الأمر التنفيذي الإلزامي لبدء العمل فورًا وفق الخطة المدمجة التالية — دون أي تأخير أو انحراف.

🎯 الهدف العام للمرحلة التأسيسية (النسخة النهائية)
الانتقال من مجرد “كتابة اختبارات” إلى “بناء محاكاة تشغيلية واقعية” تكون هي حجر الأساس لكل عمليات التطوير والاختبار المستقبلية.

يجب أن تكون بيئة الاختبار انعكاسًا مصغرًا ودقيقًا للواقع الإداري والجغرافي لقطاع المساحة — بحيث تعكس التسلسل الهرمي (ديوان → محافظة → مديرية)، وتربط المستخدمين بمناصبهم الحقيقية، وبصلاحياتهم الجغرافية الدقيقة — مما يجعل كل اختبار له معنى تشغيلي وأمني حقيقي.

🧩 المهام الإلزامية داخل المرحلة التأسيسية
تتكون المرحلة التأسيسية الآن من خمس مهام متكاملة ومترابطة — ولا يمكن اعتبارها مكتملة إلا عند إنجاز جميعها:

🧪 المهمة 0.1: API Contract Tests
استكمال تغطية جميع نقاط النهاية لخدمة القرار المساحي.
التركيز على:
حالات الصلاحيات (RBAC + LBAC).
التحقق من المدخلات (Zod schemas).
انتقالات الحالات (PATCH /applications/{id}/status).
ضمان أن كل endpoint يُرجع status code صحيحًا (403 للوصول غير المصرح، 400 للبيانات الخاطئة...).
🔐 المهمة 0.2: LBAC Matrix Tests
تنفيذ اختبارات مصفوفة الصلاحيات باستخدام المستخدمين الحقيقيين الذين سيتم إنشاؤهم في المهمة 0.5.
أمثلة:
✅ "مدير المحافظة يرى جميع طلبات محافظته، لكن لا يستطيع تعديلها".
✅ "المساح الميداني يرى ويُعدّل فقط طلبات مديريته".
❌ "موظف في عدن لا يرى طلبات صنعاء".
📱 المهمة 0.3: Mobile Sync Safety Tests
بناء اختبارات للمزامنة باستخدام بيانات مسح واقعية (نقاط، أشكال هندسية، مرفقات).
التحقق من:
موثوقية المزامنة التفاضلية (delta sync).
سلامة المرفقات أثناء الرفع والتنزيل.
سياسة حل التضارب (server-wins).
الأداء تحت ظروف offline/online.
⚙️ المهمة 0.4: Workflow State-Machine Tests
اختبار دورة حياة الطلب الكاملة:
draft → submitted → assigned → under_review → approved/rejected
منع أي انتقالات غير صالحة (مثل: الانتقال من draft مباشرة إلى approved).
ضمان سلامة سير العمل عبر:
توقيت المهام (SLA timers).
تصعيد التكليفات (escalation logic).
تتبع كامل (audit trail).
🏢 المهمة 0.5: بناء هيكل تنظيمي مصغر (إلزامية)
⚠️ هذه ليست مهمة اختيارية — بل هي شرط وجودي لإغلاق المرحلة التأسيسية.

✅ المتطلبات التنفيذية:
إنشاء سكريبت scripts/seed-organizational-structure.ts:

يقوم بإنشاء الهيكل الإداري لقطاع المساحة:
الديوان العام ← مكتب محافظة صنعاء ← مكتب مديرية سنحان وبني بهلول.
يستخدم parentId في جدول departments لبناء التسلسل الهرمي.
ينشئ المناصب المرتبطة بكل إدارة (وكيل قطاع، مدير عام، مدير محافظة، مساح ميداني...).
إنشاء مستخدمين حقيقيين:

لكل منصب، يتم إنشاء مستخدم باسم واضح ومنصب محدد.
مثال: "يوسف المساح الميداني"، "ليلى رئيس قسم الإشراف".
ربط جغرافي فعلي:

السكريبت يجب أن يستعلم عن UUIDs حقيقية لمحافظة صنعاء ومديرية سنحان من قاعدة البيانات.
ثم يستخدمها لإنشاء سجلات في user_geographic_assignments لربط كل مستخدم بنطاقه الجغرافي الصحيح.
تحديث setupTestData():

يجب تعديل دوال إعداد الاختبارات لتعتمد بالكامل على هؤلاء المستخدمين الحقيقيين.
إزالة أي بيانات وهمية أو tokens عشوائية.
📊 «Definition of Done» للمرحلة التأسيسية
لا يمكن إغلاق هذه المرحلة أو الانتقال إلى المرحلة الأولى إلا بعد تحقيق جميع المعايير التالية دون استثناء:

البند	الشرط
✅ اكتمال الاختبارات الوظيفية	جميع اختبارات المهام (0.1, 0.2, 0.3, 0.4) تعمل وتمر بنجاح.
✅ نجاح السكريبت التأسيسي	سكريبت seed-organizational-structure.ts يعمل دون أخطاء وينشئ بيئة واقعية متكاملة (إدارات، مناصب، مستخدمون، صلاحيات جغرافية).
✅ اعتمادية كاملة على البيئة الواقعية	جميع الاختبارات (safety-net, e2e, etc.) تم تعديلها لتستخدم المستخدمين والبيانات الحقيقية التي أنشأها السكريبت.
✅ نجاح حزمة الاختبارات الكاملة	الأمر npm run test:safety-net يمر بنجاح في بيئة CI/CD، مؤكدًا أن كل الأجزاء تعمل معًا بشكل متناغم.
🚀 ما بعد إغلاق المرحلة التأسيسية
بمجرد إعلان اكتمال هذه المرحلة، سنكون قد بنينا أساسًا صلبًا وموثوقًا — حيث:

الأمان مضمون عبر بيانات واقعية.
LBAC يعمل بدقة إدارية وجغرافية.
سير العمل قابل للقياس والاختبار.
المزامنة المحمولة جاهزة للبيئة الحقيقية.
وسيصبح الانتقال إلى "المرحلة 1: إكمال خدمة القرار المساحي" سلسًا ومنطقيًا — لأن البنية التحتية (الأمنية، الجغرافية، الإدارية) ستكون جاهزة لاستقبال واجهات المستخدم ومنطق سير العمل.
ستكون رحلة "تقديم المواطن للطلب" → "استلام المساح للمهمة" → "إصدار القرار" قابلة للتنفيذ الفعلي — وليس مجرد نظرية.

🔑 الخلاصة النهائية
✅ المهمة 0.5 ليست اختيارية — بل هي قلب المرحلة التأسيسية وشرط لإغلاقها.
✅ الهدف هو الثقة المطلقة في نتائج الاختبارات — لا مجال للتلاعب أو الغموض.
✅ هذه المهمة هي استثمار استراتيجي يمنع تكرار الأخطاء السابقة ويسرّع من وتيرة التطوير في المراحل اللاحقة.

📥 التوجيه التنفيذي النهائي
يُطلب منكم البدء فورًا في تنفيذ هذه الخطة المدمجة.
الأولوية القصوى هي لكتابة وتنفيذ "المهمة 0.5"، ثم إعادة تشغيل وتصحيح اختبارات المهام الأخرى بناءً على البيئة الواقعية الجديدة.
لا تنتقلوا للمرحلة 1 إلا بعد موافقتي الصريحة على إغلاق هذه المرحلة وفق معايير "Definition of Done".

انتهى الأمر.
لا استثناءات. لا تأخير. لا انحراف.

🚀 نحن نبني نظامًا رقميًا وطنيًا — وليس نموذجًا تجريبيًا. الدقة الآن هي الضمان للنجاح لاحقًا.

— قائد المشروع

