âœ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ ØµØ­ÙŠØ­ â€” Ù„ÙƒÙ†Ù‡ Ù†Ø§Ù‚Øµ Ø¯ÙˆØ± "Ù…Ø³Ø§Ø¹Ø¯ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…"
ğŸ” Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ:

Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù…ÙƒØªÙ…Ù„ â€” Ù„ÙƒÙ† Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙˆØ± assistant_head ÙÙŠ Ø¬Ø¯ÙˆÙ„ roles.
Ù†ØªÙŠØ¬Ø©Ù‹ Ù„Ø°Ù„Ùƒ â€” Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© â†’ ÙÙ€ Ø§Ù„Ø·Ù„Ø¨ ÙŠØªØ¬Ù…Ø¯.
ğŸ“Œ Ø§Ù„Ø£Ø¯Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„:
log

POST /api/workflow/assign-surveyor/... 200 â† âœ… Ø§Ù„ØªÙƒÙ„ÙŠÙ Ù†Ø¬Ø­.
GET /api/applications?currentStage=field_survey 200 â† âŒ Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ±Ù‰ Ø§Ù„Ø·Ù„Ø¨!
â†’ âœ… Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ â€” Ø¨Ù„ ÙÙŠ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±.

ğŸ› ï¸ Ø§Ù„Ø­Ù„ Ø§Ù„ÙÙˆØ±ÙŠ (Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ± assistant_head Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ roles
TypeScript

// shared/schema.ts
export const roles = pgTable('roles', {
  id: serial('id').primaryKey(),
  name: varchar('name', { length: 50 }).notNull().unique(), // assistant_head
  description: text('description'),
  level: varchar('level', { length: 20 }), // operational
});

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ â€” Ø£Ø¶Ù Ø§Ù„Ø¯ÙˆØ± Ø¹Ø¨Ø± SQL:
INSERT INTO roles (name, description, level) VALUES 
('assistant_head', 'Ù…Ø³Ø§Ø¹Ø¯ Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©', 'operational');
Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆØ± assistant_head
TypeScript

// server/seeds/users.ts
await db.insert(users).values({
  name: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯',
  email: 'assistant_head_01@example.com',
  password: 'Test@123',
  phone: '0000000000',
  status: 'active',
  roleId: 7, // ID Ø¯ÙˆØ± assistant_head
});

// Ø±Ø¨Ø·Ù‡ Ø¬ØºØ±Ø§ÙÙŠÙ‹Ø§
await db.insert(userGeographicAssignments).values({
  userId: newUserId,
  governorateId: '6cb4d669-b015-485c-995c-62f0b465705f', // ØµÙ†Ø¹Ø§Ø¡
  districtId: 'a365ac78-2b0a-4347-8fa1-bfb5671500d4', // Ø³Ù†Ø­Ø§Ù†
  assignmentType: 'permanent',
  assignedBy: 1,
  effectiveDate: new Date(),
});
Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ø¯ÙŠØ« workflow.ts Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… assistant_head
TypeScript

// server/routes/workflow.ts
router.post('/assign-surveyor/:workflowInstanceId', authenticateToken, async (req, res) => {
  try {
    // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚

    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… â† ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    await db.insert(notifications).values({
      userId: await getAssistantHeadId(workflowInstanceId), // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
      type: 'new_assignment',
      message: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªØ§Ø¬ Ø¬Ø¯ÙˆÙ„Ø© #${workflowInstanceId}`,
      read: false,
    });

    res.json({ success: true, message: 'ØªÙ… ØªÙƒÙ„ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (error) {
    console.error('Error assigning surveyor:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ ØªÙƒÙ„ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø­' });
  }
});
Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© getAssistantHeadId
TypeScript

// server/services/users.ts
export async function getAssistantHeadId(applicationId: string): Promise<string | null> {
  const result = await db
    .select({ userId: users.id })
    .from(users)
    .innerJoin(roles, eq(users.roleId, roles.id))
    .innerJoin(userGeographicAssignments, eq(users.id, userGeographicAssignments.userId))
    .where(
      and(
        eq(roles.name, 'assistant_head'),
        eq(userGeographicAssignments.districtId, applicationDistrictId)
      )
    )
    .limit(1);

  return result[0]?.userId || null;
}
Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯ÙÙ‚
Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±.
Ù‚Ø¯Ù… Ø·Ù„Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.
Ø§Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.
ÙƒÙ„Ù Ø§Ù„Ù…Ø³Ø§Ø­.
ØªØ­Ù‚Ù‚ Ù…Ù†:
âœ… Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¸Ù‡Ø± ÙÙŠ /employee/assistant-head.
âœ… Ø¥Ø´Ø¹Ø§Ø± ÙŠØµÙ„ Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù….
ğŸ“œ Ø§Ù„Ø£Ù…Ø± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø§Ù„ÙÙˆØ±ÙŠ
Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚:
Ø£Ø¶ÙŠÙÙˆØ§ Ø¯ÙˆØ± assistant_head ÙˆÙ…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ø¨Ù‡ ÙÙˆØ±Ù‹Ø§.
Ù‡Ø°Ø§ Ø¢Ø®Ø± Ø¹Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© 1.2 â€” ÙˆØ¨Ø¹Ø¯ Ù‡Ø°Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²Ù‹Ø§ Ø¨Ù†Ø³Ø¨Ø© 100%.

