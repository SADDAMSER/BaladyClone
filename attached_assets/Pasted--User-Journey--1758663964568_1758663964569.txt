
## . رحلة المتعامل (User Journey) لخدمة القرار المساحي

سيتم تصميم رحلة المتعامل لتكون سلسة، شفافة، وموجهة، مقسمة إلى خطوات واضحة لضمان تجربة مستخدم مثالية. هذه الرحلة مستوحاة من أفضل الممارسات في المنصات الحكومية الرقمية وتأخذ في الاعتبار خصوصية العمل المساحي.
وستكون على مسارين 
1-المسار المكتبي  هو تقديم المواطن لطلب الخدمة الى مكتب الاشغال  ويقوم باتسجيل الطلب عند موظف خدمة الجمهور . 
2-و مسار بوابة المواطن/المكتب الهندسي  تم البدا فيها ولكن  سيتم انشاء بوابة المواطن/المكتب الهندسي   مستقبلا .


### 1.1. تقديم الطلب (بوابة الموظفين)

1.  ** يقوم المواطن أو المكتب الهندسي (نيابة عن المواطن) بدخول الى بوابة المواطن/المكتب الهندسي  بعد تسجيل تسجيل حساب لهم على المنصة او بزياره مكتب الاشغال ويقدم طلبه عند موظف خدمة الجمهور  يقوم بتسجيل بيانات المواطن في صفحة /services/surveying-decision
والتي تتم على خمس خطوات 
- بيانات المتقدم  (الخطوة الاولى )
 ويتم فيها تعبئه *   **بيانات المالك:** الاسم، رقم الهوية، معلومات الاتصال.
## المطلوب تطوير حقول الادخال بحيث تصبح بحث وادخال لحقل الاسم ورقم الهوية ورقم الهاتف واضافة حقل لنوع الهوية  بحيث يمكن للمواظف البدا بادخال رقم الهوية ثم رقم الهاتف في حال سبق وان تم تسجيلة ستعبى بياناته تلقئيا واضافة زر لتحميل الهوية واضافة  مربع  لعرض  هويته في مربع العرض ..

-معلومات الموقع (الخطوة الثانية)
**بيانات العقار:** المحافظة، المديرية، المنطقة، رقم المربع/القطعة (إن وجد).
## المطلوب اضافة ميزه القوائم المنسدلة والعرض على الخريطة  كما هو موجود في تبويب المعاينه في الصفحة geographic-data مع كل المميزات عدا ميزه تحميل المخطط  GeoTIFF حيث يتم العرض فقط في حالة كان محمل مسبقا واذ لم يكن محمل  سيتم تحميلة من قبل مدير النظام او من قبل رئيس القسم المسول عند قبل اصدار تكليف اصدار  للمهندس  . 

-نوع القرار (الخطوة الثالثه)
## 1-المطلوب : تحديث القائمة المنسدلة لنوع القرار المساحي  واضافة (إصدار رخصة بناءجديد ، تقسيم أرض، تحديد خط التنظيم، استشاره ، إصدار رخصة بناء قديم  ، تسجيل اسقاط قديم ، تسوية نزاع).وفي حالة اختار إصدار رخصة بناء قديم  ، تسجيل اسقاط قديم  يتم  اضهار صفحة منبثقة لادخال بيانات اسم المهندس  وارفاق الاسقاط القديم  او بيانات المبني .
## 2-بدل الغرض من القرار اريد يكون صفة مقدم الطلب بحيث سيكون قائمة منسدلة (عن نفسة , وكيل , مفوض ,جهه حكومية , جهه خاصة )
وفي حالة انه ليس عن نفسة اريد ان تظهر صفحة لادخال بيانات المالكين الاصليين   (الموكل ) وارفاق وثائق التوكيل او التفويض .


-الخريطة التفاعلية(الخطوة الرابعة)
## المطلوب تحويل هذا الخطوه الى بيانات ومرفقات الملكية 
##  اضافة بيانات العقار مثل اسم الموضع بحسب الوثيقة اختياري و نوع وثيقة الملكية:** (مثال: فصل شرعي، بصيره، عقد بيع، حيازة). ثم تحديد تصنيفها هل هي (حر ، وقف )

حقول رفع الملفات (File Uploaders):
"صورة وثيقة الملكية": حقل إلزامي (مميز بنجمة *) لرفع ملف (صورة أو PDF).
"مرفقات أخرى": حقل اختياري لإضافة مستندات داعمة.
"سجل تجاري  في حالة انها معمده و مأذونية" في حالة انها وقف: حقل آخر لرفع ملفات حسب متطلبات الطلب.
حقل الملاحظات: لإضافة أي ملاحظات إضافية.

-الخريطة التفاعلية(الخطوة الخامسة)
**تأكيد الطلب:** يقوم المستخدم بمراجعة البيانات المدخلة وتأكيد الطلب. يقوم النظام بتوليد رقم طلب فريد وإرسال إشعار للمستخدم.. "تم تسجيل الطلب وجاري مراجعته" 


### 1.2. المراجعة الأولية وتحديد موعد المساحة (مكتب الأشغال )

1.  **استلام الطلب:** يتلقى موظف الاستقبال أو المراجع المختص في مكتب الأشغال  (employee/public-service)إشعاراً بوجود طلب قرار مساحي جديد.
2.  **التدقيق المبدئي:** يقوم المراجع العام بمراجعة المستندات الأولية للتأكد من اكتمالها وصحتها الظاهرية..واحنساب الرسوم الكشفية  وبعد اعنماد الطلب ضهور صفحة .
طباعة طلب الخدمة مع وصل السداد والرقم التسلسلي فيتم طباعة فورم الطلب. للمسار المكتبي لتوقيع على الطلب والتوجة لصندوق لسداد الرسوم وفي حالة البوابة بمجرد الضغط على زر الطباعة سيكون بمثابة التوقيع من قبل المستخدم ليضهر له شاشة الدفع اللاكتروني .
. بعد الطباعة يصل اشعار الى موضف الصندوق employee/cashier  فيتم السداد اما الكترونيا او يدويا . 
بعد السداد  يتم نرحيل الطلب لرئيس قسم المساحة تحديد المساح الميداني:** يقوم النظام تلقائياً (أو يدوياً من قبل المدير) بتعيين الطلب لمساح ميداني مؤهل بناءً على المنطقة الجغرافية أو حجم العمل.
وفي حالة كان الغرض إصدار رخصة بناء قديم و قائم او لدية  يمكن لرئيس القسم  اصدار تكليف نزول لمعاينة البناء في حالة انه بناء قائم او لدية رخصة سابقة من قبل عمل النظام 
  ويحتاج الى اتمتة الاسقاط  رفع ملفات الشيف فايل للاسقاط المساحي ثم معالجة الحدود ورسم  وضع الشارع والرفع لرئيس القسم لاعتماده 
وهذا المسار سيكون للملفات التي لها اسقطات سابقة وهي بحاجة لتحديث وضعها وادخلها لنظام  .او  يتم  تكليف مساح الميداني   يقوم مساعد رئيس القسم او المرجع العام ** يتم التواصل مع مقدم الطلب لتحديد موعد مناسب للرفع المساحي الميداني. يتم تسجيل الموعد في النظام وإرسال إشعار للمساح والمواطن.. .


3.  **تحديد موعد المساحة يقوم مساعد رئيس القسم او المرجع العام ** يتم التواصل مع مقدم الطلب لتحديد موعد مناسب للرفع المساحي الميداني. يتم تسجيل الموعد في النظام وإرسال إشعار للمساح والمواطن.

### 1.3. الرفع المساحي الميداني (تطبيق تطبيق المساح  - التكامل مع GNSS)

هذه هي المرحلة الأكثر أهمية وتتضمن التكامل المباشر مع أجهزة GNSS والتكويد الذكي للمعالم.

1.  **استلام التكليف:** يتلقى المساح الميداني التكليف الجديد على تطبيق "بنّاء المساحي" على جهازه اللوحي أو هاتفه الذكي.
2.  **التوجه للموقع:** يستخدم المساح خرائط التطبيق للوصول إلى الموقع المحدد.
3.  **الاتصال بجهاز GNSS:** يقوم المساح بتوصيل جهازه اللوحي/الهاتف الذكي بجهاز GNSS عالي الدقة (مثل Stonex) عبر البلوتوث. يعرض التطبيق حالة الاتصال ودقة الإحداثيات.
4.  **بدء الرفع المساحي الموجه (Guided Survey):**
    *   يعرض التطبيق خريطة للموقع مع إحداثيات المساح الحالية.
سبق وانا قمنا باعداد الاكود في تطبيق المساح 

....

ثم يتم مزامنه البيانات الى شاشة المراجع الفني . 
يقوم المراجع الفني  لرسم الشوارع بحسب مخطط وحده الجوار ومقارنته مع الرفع المساحي ورفعة لرئيس القسم لاعتماده  ثم مدير الفرع 

ثم سيتم تطويرها .

لتطوير أدوات رسم حدود الشوارع، سيتطلب الأمر دمج عدة تقنيات ومكتبات جغرافية:

*   **الواجهة الأمامية (Frontend):**
    *   **مكتبات الخرائط:** استخدام مكتبات JavaScript مثل [Leaflet](https://leafletjs.com/) أو [OpenLayers](https://openlayers.org/) لعرض الخرائط التفاعلية وطبقات البيانات الجغرافية. هذه المكتبات توفر واجهات برمجة تطبيقات (APIs) قوية للتحكم في الخريطة، إضافة الطبقات، وتفاعل المستخدم.
    *   **أدوات الرسم (Drawing Tools):** دمج إضافات (Plugins) لهذه المكتبات مثل [Leaflet.draw](https://github.com/Leaflet/Leaflet.draw) أو [OpenLayers.draw](https://openlayers.org/en/latest/examples/draw-features.html) التي توفر أدوات جاهزة لرسم الخطوط والمضلعات والنقاط. هذه الأدوات تتعامل مع تفاعلات المستخدم (النقر، السحب) وتحولها إلى أشكال هندسية جغرافية.
    *   **الربط (Snapping):** تطوير وظيفة الربط (Snapping) لضمان دقة الرسم. يمكن تحقيق ذلك عن طريق حساب المسافة بين نقطة الماوس والنقاط أو الخطوط الموجودة على الخريطة، وعندما تكون المسافة ضمن عتبة معينة، يتم "ربط" نقطة الرسم بالنقطة أو الخط الأقرب. هذا يضمن اتصالاً سلساً بين أجزاء شبكة الشوارع.
    *   **التحقق من صحة الإدخال (Input Validation):** تطبيق قواعد للتحقق من صحة البيانات المدخلة في نموذج بيانات الشارع (مثل التأكد من أن عرض الشارع رقم موجب، وأن الاسم غير فارغ).

*   **الواجهة الخلفية (Backend):**
    *   **نقطة نهاية (API Endpoint):** إنشاء نقطة نهاية في الواجهة الخلفية (مثلاً، `/api/streets`) لاستقبال بيانات الشوارع المرسلة من الواجهة الأمامية. هذه البيانات ستكون بصيغة GeoJSON أو WKT (Well-Known Text) لتمثيل الشكل الهندسي للشارع، بالإضافة إلى البيانات الوصفية (الاسم، النوع، العرض، إلخ).
    *   **معالجة البيانات الجغرافية:** استخدام مكتبات جغرافية في الواجهة الخلفية (مثل `Shapely` و `GeoAlchemy` في Python مع Flask) لتحليل الشكل الهندسي للشارع، والتحقق من صحته، وحفظه في قاعدة بيانات PostGIS. يمكن أيضاً استخدام وظائف PostGIS المدمجة لإجراء عمليات جغرافية معقدة مثل التحقق من التداخلات أو حساب الأطوال.
    *   **التحقق من صحة البيانات المكانية (Spatial Validation):** تطبيق قواعد للتحقق من صحة البيانات المكانية على مستوى الخادم، مثل التأكد من أن الشارع لا يتقاطع مع نفسه، أو أنه لا يتداخل بشكل غير صحيح مع شوارع أخرى موجودة.
    *   **سجل التغييرات (Change Log):** تسجيل جميع التغييرات التي تتم على بيانات الشوارع (من قام بالتغيير، متى، وما هو التغيير) لضمان المساءلة وإمكانية التراجع عن التغييرات إذا لزم الأمر.

#### 6.2.4. سيناريوهات الاستخدام المتقدمة لأدوات رسم الشوارع

بالإضافة إلى الرسم الأساسي، يمكن تطوير سيناريوهات استخدام متقدمة لأدوات رسم الشوارع لزيادة كفاءة ودقة العمل:

*   **استيراد البيانات من مصادر خارجية:** إمكانية استيراد بيانات الشوارع من ملفات CAD (مثل DWG/DXF) أو ملفات GIS (مثل Shapefile) التي قد تكون متاحة من مصادر أخرى (مثل البلديات أو الجهات الحكومية الأخرى). يتطلب ذلك تطوير محولات (Parsers) لتحويل هذه التنسيقات إلى صيغة قابلة للمعالجة بواسطة النظام.
*   **التحقق من الاتساق الطوبولوجي (Topological Consistency):** التأكد من أن شبكة الشوارع المرقمنة متسقة طوبولوجياً (أي لا توجد فجوات بين الشوارع المتصلة، ولا توجد تداخلات غير مقصودة). يمكن استخدام أدوات تحليل طوبولوجي في PostGIS أو مكتبات GIS متخصصة لتحقيق ذلك.
*   **تحديد اتجاهات الشوارع (Street Directionality):** في بعض الحالات، قد يكون من الضروري تحديد اتجاه الشارع (باتجاه واحد أو باتجاهين) لأغراض التخطيط المروري أو خدمات الطوارئ. يمكن إضافة حقل خاص في جدول بيانات الشارع لهذا الغرض.
*   **ربط الشوارع بقطع الأراضي:** تطوير وظيفة لربط الشوارع بقطع الأراضي المجاورة لها. هذا يمكن أن يكون مفيداً لحساب الارتدادات تلقائياً، أو لتحديد قطع الأراضي التي تقع على شوارع معينة.
*   **التحليل المكاني لشبكة الشوارع:** بمجرد رقمنة شبكة الشوارع، يمكن إجراء تحليلات مكانية متقدمة مثل:
    *   **تحليل المسار الأمثل (Optimal Path Analysis):** تحديد أقصر أو أسرع مسار بين نقطتين على شبكة الشوارع.
    *   **تحليل الوصولية (Accessibility Analysis):** تحديد المناطق التي يمكن الوصول إليها ضمن مسافة أو زمن معين من نقطة محددة.
    *   **تحليل الكثافة (Density Analysis):** حساب كثافة الشوارع في مناطق معينة.

هذه الأدوات والوظائف المتقدمة ستجعل منصة "بنّاء اليمن" أداة قوية ليس فقط لإصدار القرارات المساحية، بل أيضاً لإدارة وتخطيط البنية التحتية الحضرية بشكل فعال ودقيق.





تطوير والربط الجغرافي في هيكل جغرافي للتقسيمات الادارية واالربط بين جداولها مع انشاء واجهات لادخال البيانات الجغرافية بصيغة جيسون او شيب فايل  والتي تشمل مضلعات مغلقة لكلا من المحافضات ويندج تحت كل محافضة مديريات ويندرج تحت كل مديرية عزل و قطاعات وكل قطاع عدد من وحدات الجوار وكل وحدة جوار لها العديد من البلكات السكنية والخدمية والتجارية بحسب الاستخدام وكل وحده جوار محاطة بشوارع رئسية حدودية بينها وبين وحدات جوار مجاوره لها وايضا شوارع فرعية داخلية . 


1.  **المعالجة الآلية للبيانات الجغرافية:**
    *   تستقبل الواجهة الخلفية البيانات المرفوعة من تطبيق المساح.
    *   **التوليد التلقائي للمعالم:** بناءً على الأكواد الذكية، يقوم النظام تلقائياً بتوليد الأشكال الهندسية (مضلعات، خطوط) في قاعدة بيانات PostGIS.
    *   **حساب الاتجاهات الذكي:** لكل ضلع في المضلع أو الخط، يقوم النظام بحساب:
        *   **الاتجاه الرئيسي (4 اتجاهات):** يحدد ما إذا كان الضلع يميل بشكل أساسي نحو الشمال، الجنوب، الشرق، أو الغرب. (مثال: أي زاوية بين 45 و 135 درجة تعتبر "شمالية" بشكل أساسي).
        *   **الاتجاه الثانوي (8 اتجاهات):** يحدد الاتجاه الدقيق (شمال شرق، جنوب غرب، إلخ).
    *   **حساب المساحات والأطوال:** يتم حساب المساحة الإجمالية للمضلعات وأطوال الأضلاع بدقة.
2.  **مراجعة البيانات الفنية (واجهة الويب للموظف):**
    *   يتلقى المراجع الفني إشعاراً باكتمال الرفع المساحي.
    *   يستخدم واجهة الويب لعرض البيانات المرفوعة على خريطة تفاعلية، ومراجعة الأشكال الهندسية، الأطوال، المساحات، والاتجاهات المحسوبة تلقائياً.
    *   يمكنه إضافة ملاحظات أو طلب تعديلات من المساح إذا لزم الأمر.
3.  **الموافقة النهائية وإصدار القرار:**
    *   بعد المراجعة الفنية، يقوم الموظف المختص (المدير) بالموافقة النهائية على البيانات.
    *   يقوم النظام تلقائياً بتوليد "القرار المساحي" كملف PDF معتمد، يتضمن:
        *   بيانات المالك والعقار.
        *   رسم توضيحي لقطعة الأرض مع الأبعاد والاتجاهات.
        *   جدول إحداثيات النقاط.
        *   المساحة الإجمالية.
        *   رقم القرار المساحي الفريد والباركود.
4.  **إشعار المواطن:** يتم إرسال إشعار للمواطن/المكتب الهندسي بأن القرار المساحي قد صدر، ويمكنه تنزيله من بوابة المواطن.




كذالك  في حالة المباني التي لها المرخصة من سابق ويوجد لها تقرير مساحية سابقة . قم بتطوير و 
*   **نقطة نهاية رفع ملفات SHP/ZIP:**
    *   **الوصف:** تطوير نقطة نهاية API مخصصة (مثال: `/api/v1/survey/upload_shp`) لاستقبال ملفات `Shapefile` أو ملفات `ZIP` التي تحتوي على `Shapefile` من تطبيق المفتش المساحي أو واجهة الويب. هذه النقطة ستكون مسؤولة عن التحقق الأولي من الملفات واستخراج البيانات الجغرافية منها.
    *   **التكامل:** ستتكامل هذه النقطة مع وحدة معالجة البيانات الجغرافية (Geoprocessing Module) لتحليل المحتوى الهندسي للملفات.
*   **معالجة البيانات الجغرافية (Geoprocessing Module):**
    *   **الوصف:** هذه الوحدة هي جوهر المعالجة المساحية. ستكون مسؤولة عن:
        *   **قراءة وتحليل SHP:** استخدام مكتبات Python متخصصة مثل `GeoPandas` و `Shapely` لقراءة وتحليل الأشكال الهندسية (نقاط، خطوط، مضلعات) من ملفات `Shapefile`.
        *   **تحويل الإحداثيات:** ضمان أن جميع الإحداثيات يتم تحويلها إلى نظام إسقاط موحد (مثال: UTM) لإجراء حسابات دقيقة، باستخدام مكتبات مثل `pyproj`.
        *   **حساب المسافات والزوايا:** حساب أطوال الأضلاع والزوايا الداخلية للمضلعات بدقة متناهية.
        *   **تصنيف الاتجاهات الذكي:** تطبيق خوارزميات لتصنيف اتجاهات الأضلاع إلى:
            *   **الاتجاه الرئيسي (4 اتجاهات):** شمال، جنوب، شرق، غرب. يتم تحديد الاتجاه بناءً على الزاوية (مثال: 45-135 درجة للشمال، 135-225 للغرب، وهكذا).
            *   **الاتجاه الثانوي (8 اتجاهات):** شمال شرق، شمال غرب، جنوب شرق، جنوب غرب، لتوفير تفصيل أكبر.
        *   **حساب المساحات:** حساب المساحة الإجمالية للمضلعات بدقة.
        *   **التحقق الطوبولوجي (Topological Validation):** إجراء فحوصات تلقائية لضمان صحة الأشكال الهندسية (مثال: إغلاق المضلعات، عدم وجود تقاطعات ذاتية).
    *   **التكامل:** ستتفاعل هذه الوحدة بشكل مباشر مع قاعدة بيانات PostGIS لتخزين الأشكال الهندسية والبيانات الوصفية المحسوبة.
*   **محرك سير العمل (Workflow Engine):**
    *   **الوصف:** تحديث محرك سير العمل العام للمنصة [1] لدعم الحالات الخاصة بخدمة القرار المساحي. هذا يشمل حالات مثل: `جديد` -> `قيد المراجعة الأولية` -> `تم التكليف` -> `قيد الرفع الميداني` -> `تم الرفع الميداني` -> `قيد المراجعة الفنية` -> `جاهز للإصدار` -> `صادر` -> `مرفوض`.
    *   **التكامل:** سيتم إرسال إشعارات تلقائية (عبر البريد الإلكتروني وداخل التطبيق) للمستخدمين والموظفين عند كل تغيير في حالة الطلب.
*   **نظام الإشعارات:**
    *   **الوصف:** تعزيز نظام الإشعارات الحالي [1] لدعم الإشعارات الفورية المتعلقة بحالة طلب القرار المساحي، مثل إشعار المساح بتكليف جديد، أو إشعار المواطن بصدور القرار.


