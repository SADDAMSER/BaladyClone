# دليل دمج تحسينات API مع دعم التصفح

## نظرة عامة

تم إنشاء ثلاثة ملفات جديدة لتحسين الواجهة الخلفية بإضافة دعم التصفح (Pagination) والبحث والتصفية:

1. **`pagination-utils.ts`** - دوال مساعدة للتصفح والبحث
2. **`tasks-api.ts`** - endpoints إدارة المهام مع دعم التصفح
3. **`enhanced-endpoints.ts`** - تحسينات للـ endpoints الموجودة

## خطوات الدمج

### الخطوة 1: إضافة utility functions للتصفح

```typescript
// في بداية ملف api.ts، أضف الاستيراد التالي:
import { 
  executePaginatedQuery, 
  validatePaginationParams, 
  createErrorResponse, 
  createSuccessResponse,
  type PaginationParams 
} from "./pagination-utils";
```

### الخطوة 2: دمج endpoints المهام

في دالة `registerRoutes` في ملف `api.ts`, أضف الكود التالي:

```typescript
// استيراد دالة تسجيل endpoints المهام
import { registerTasksEndpoints } from "./tasks-api";

// داخل دالة registerRoutes، أضف:
registerTasksEndpoints(app, db, storage, authenticateToken, requireRole, enforceLBACAccess, validateRequest);
```

### الخطوة 3: دمج التحسينات للـ endpoints الموجودة

```typescript
// استيراد دالة التحسينات
import { registerEnhancedEndpoints } from "./enhanced-endpoints";

// داخل دالة registerRoutes، أضف:
registerEnhancedEndpoints(app, db, storage, authenticateToken, requireRole, enforceLBACAccess);
```

### الخطوة 4: إضافة dependencies المطلوبة

تأكد من وجود الحزم التالية في `package.json`:

```json
{
  "dependencies": {
    "zod": "^3.22.0",
    "drizzle-orm": "latest"
  }
}
```

## الميزات الجديدة

### 1. endpoints المهام الجديدة

- `GET /api/tasks` - جلب المهام مع تصفح وبحث وتصفية
- `GET /api/tasks/:id` - جلب مهمة محددة مع معلومات إضافية
- `POST /api/tasks` - إنشاء مهمة جديدة مع إشعارات
- `PUT /api/tasks/:id` - تحديث مهمة موجودة
- `DELETE /api/tasks/:id` - حذف مهمة
- `PUT /api/tasks/:id/status` - تحديث حالة المهمة
- `GET /api/tasks/stats` - إحصائيات المهام
- `GET /api/tasks/my-tasks` - المهام الخاصة بالمستخدم الحالي

### 2. endpoints محسنة للطلبات

- `GET /api/applications/paginated` - جلب الطلبات مع تصفح متقدم
- `GET /api/applications/stats` - إحصائيات الطلبات

### 3. endpoints محسنة للمستخدمين

- `GET /api/users/paginated` - جلب المستخدمين مع تصفح متقدم
- `GET /api/users/search` - البحث السريع في المستخدمين

### 4. endpoints محسنة للأقسام

- `GET /api/departments/paginated` - جلب الأقسام مع تصفح
- `GET /api/dashboard/stats` - إحصائيات لوحة التحكم

## معاملات التصفح المدعومة

جميع endpoints الجديدة تدعم المعاملات التالية:

```typescript
{
  page: number,        // رقم الصفحة (افتراضي: 1)
  limit: number,       // عدد العناصر في الصفحة (افتراضي: 20، أقصى: 100)
  sortBy: string,      // الحقل المراد الترتيب حسبه
  sortOrder: 'asc' | 'desc', // اتجاه الترتيب (افتراضي: desc)
  search: string,      // نص البحث
  filters: object      // مرشحات إضافية
}
```

### مثال على الاستخدام:

```
GET /api/tasks?page=1&limit=20&sortBy=createdAt&sortOrder=desc&search=مسح&filters[status]=pending&filters[priority]=high
```

## تنسيق الاستجابة

جميع endpoints الجديدة ترجع البيانات بالتنسيق التالي:

```typescript
{
  success: true,
  data: {
    data: [...],           // البيانات الفعلية
    pagination: {
      page: 1,
      limit: 20,
      total: 150,
      totalPages: 8,
      hasNext: true,
      hasPrev: false
    },
    filters: {...},        // المرشحات المطبقة
    sort: {
      field: "createdAt",
      order: "desc"
    }
  },
  message: "...",          // رسالة اختيارية
  timestamp: "2025-01-16T..."
}
```

## الأمان والصلاحيات

- جميع endpoints تطبق نظام المصادقة (Authentication)
- تطبيق نظام الصلاحيات (RBAC) حسب دور المستخدم
- تطبيق نظام التحكم الجغرافي (LBAC) حيث ينطبق
- حماية من SQL Injection عبر استخدام Drizzle ORM
- التحقق من صحة البيانات باستخدام Zod

## الأداء

- استخدام indexes مناسبة لتحسين أداء الاستعلامات
- تحديد حد أقصى للعناصر في الصفحة (100 عنصر)
- تحسين الاستعلامات لتجنب N+1 queries
- استخدام parallel queries حيث أمكن

## اختبار التحسينات

بعد الدمج، يمكن اختبار endpoints الجديدة باستخدام:

1. **Postman** أو **Insomnia** لاختبار API
2. **curl** commands للاختبار السريع
3. **Frontend integration** مع React components

### مثال اختبار curl:

```bash
# جلب المهام مع تصفح
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/tasks?page=1&limit=10&sortBy=createdAt&sortOrder=desc"

# البحث في المستخدمين
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/users/search?q=أحمد&role=engineer&limit=5"

# إحصائيات لوحة التحكم
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/dashboard/stats"
```

## الخطوات التالية

1. دمج الملفات مع API الرئيسي
2. اختبار جميع endpoints الجديدة
3. تحديث الواجهة الأمامية لاستخدام التصفح الجديد
4. إضافة indexes إضافية لقاعدة البيانات إذا لزم الأمر
5. مراقبة الأداء وتحسينه حسب الحاجة

