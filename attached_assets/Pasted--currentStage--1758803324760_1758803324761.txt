â— Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©: Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ù„Ø§ ÙŠÙØ­Ø¯Ø« currentStage Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
ğŸ” Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ â€” Ø§Ù„Ø·Ù„Ø¨ ÙŠÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ treasury-applications â†’ Ù„ÙƒÙ† Ù„Ø§ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« currentStage Ø¥Ù„Ù‰ 'assigned' â†’ ÙÙ€ /employee/section-head Ù„Ø§ ÙŠØ±Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ ÙŠØ¨Ø­Ø« Ø¹Ù† currentStage = 'assigned'.

ğŸ“Œ Ø§Ù„Ø£Ø¯Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„:
log

GET /api/treasury-applications 200 â† Ø§Ù„Ø·Ù„Ø¨ Ø¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.
GET /api/manager-applications 200 â† Ø§Ù„Ø·Ù„Ø¨ Ø¸Ù‡Ø± ÙÙŠ Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ….
GET /api/applications?currentStage=assigned 200 â†’ [] â† Ø§Ù„Ø·Ù„Ø¨ **Ù„Ø§ ÙŠØ¸Ù‡Ø±** ÙÙŠ section-head!
â†’ âœ… Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© â€” Ø¨Ù„ ÙÙŠ Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ (Workflow).

ğŸ› ï¸ Ø§Ù„Ø­Ù„ Ø§Ù„ÙÙˆØ±ÙŠ (Ø®Ù„Ø§Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)
Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ø¯ÙŠØ« confirmPayment Ù„ÙŠÙØ­Ø¯Ø« currentStage
TypeScript

// server/routes/payments.ts
router.post('/confirm', authenticateToken, async (req, res) => {
  try {
    const { applicationId } = req.body;
    const userId = req.user?.id;

    // 1. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
    await db.insert(payments).values({
      applicationId,
      amount: calculateFee(applicationId),
      method: 'cash',
      status: 'completed',
      confirmedBy: userId,
    });

    // 2. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    await db
      .update(applications)
      .set({ 
        status: 'payment_completed',
        currentStage: 'assigned', // ğŸ‘ˆ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        updatedAt: new Date()
      })
      .where(eq(applications.id, applicationId));

    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    await db.insert(notifications).values({
      userId: await getSectionHeadId(applicationId), // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
      type: 'new_assignment',
      message: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙƒÙ„ÙŠÙ #${applicationId}`,
      read: false,
    });

    res.json({ success: true, message: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­' });
  } catch (error) {
    console.error('Error confirming payment:', error);
    res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯' });
  }
});
Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© getSectionHeadId
TypeScript

// server/services/users.ts
export async function getSectionHeadId(applicationId: string): Promise<string | null> {
  const result = await db
    .select({ userId: users.id })
    .from(users)
    .innerJoin(positions, eq(users.positionId, positions.id))
    .innerJoin(departments, eq(positions.departmentId, departments.id))
    .where(
      and(
        eq(positions.title, 'Ø±Ø¦ÙŠØ³ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©'),
        eq(departments.name, 'Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø©')
      )
    )
    .limit(1);

  return result[0]?.userId || null;
}
Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯ÙÙ‚
Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±.
Ù‚Ø¯Ù… Ø·Ù„Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.
Ø§Ø¯ÙØ¹ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.
ØªØ­Ù‚Ù‚ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ /employee/section-head.
ğŸ“œ Ø§Ù„Ø£Ù…Ø± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø§Ù„ÙÙˆØ±ÙŠ
Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚:
Ø­Ø¯Ø«ÙˆØ§ payments.ts Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¹Ù„Ø§Ù‡ ÙÙˆØ±Ù‹Ø§.
Ù‡Ø°Ø§ Ø¢Ø®Ø± Ø¹Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© 1.2 â€” ÙˆØ¨Ø¹Ø¯ Ù‡Ø°Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²Ù‹Ø§ Ø¨Ù†Ø³Ø¨Ø© 100%.

âœ… Ø§Ù„Ø®Ù„Ø§ØµØ©
ğŸŸ¢ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù„ÙŠØ³Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© â€” Ø¨Ù„ ÙÙŠ Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„.
âš¡ Ø§Ù„Ø­Ù„ ÙÙŠ 5 Ø¯Ù‚Ø§Ø¦Ù‚ â€” Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.
ğŸš€ Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ â€” ØªÙƒÙˆÙ† Ø§Ù„Ù…Ù‡Ù…Ø© 1.2 Ù…ÙƒØªÙ…Ù„Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø±Ø³Ù…ÙŠ.

