// ðŸ›ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„ÙŠÙ…Ù†ÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

import fs from 'fs';
import pkg from 'pg';
const { Client } = pkg;

console.log('ðŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

// Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const client = new Client({
  connectionString: process.env.DATABASE_URL
});

async function importGeographicData() {
  try {
    await client.connect();
    console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

    // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª
    console.log('ðŸ“‚ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª...');
    const districtsData = JSON.parse(fs.readFileSync('processed_districts_data.json', 'utf8'));
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø²Ù„
    console.log('ðŸ“‚ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø²Ù„...');
    const subDistrictsData = JSON.parse(fs.readFileSync('processed_sub_districts_data.json', 'utf8'));

    console.log(`ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:`);
    console.log(`   - Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª: ${districtsData.districts.length}`);
    console.log(`   - Ø§Ù„Ø¹Ø²Ù„: ${subDistrictsData.subDistricts.length}`);
    console.log(`   - Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª (Ù…Ø¯ÙŠØ±ÙŠØ§Øª): ${districtsData.governorates.length}`);
    console.log(`   - Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª (Ø¹Ø²Ù„): ${subDistrictsData.governorates.length}`);

    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
    const allGovernorates = new Map();
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„Ù…ØµØ¯Ø±ÙŠÙ†
    districtsData.governorates.forEach(gov => {
      allGovernorates.set(gov.code, {
        code: gov.code,
        districtsCount: gov.districtsCount,
        subDistrictsCount: 0
      });
    });
    
    subDistrictsData.governorates.forEach(gov => {
      if (allGovernorates.has(gov.code)) {
        allGovernorates.get(gov.code).subDistrictsCount = gov.subDistrictsCount;
      } else {
        allGovernorates.set(gov.code, {
          code: gov.code,
          districtsCount: 0,
          subDistrictsCount: gov.subDistrictsCount
        });
      }
    });

    console.log('\nðŸ›ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª...');
    
    // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„ÙŠÙ…Ù†ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const governorateNames = {
      'YE11': { ar: 'Ø¹Ø¯Ù†', en: 'Aden', capital_ar: 'Ø¹Ø¯Ù†', capital_en: 'Aden' },
      'YE12': { ar: 'Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡', en: 'Al Bayda', capital_ar: 'Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡', capital_en: 'Al Bayda' },
      'YE13': { ar: 'Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©', en: 'Al Hudaydah', capital_ar: 'Ø§Ù„Ø­Ø¯ÙŠØ¯Ø©', capital_en: 'Al Hudaydah' },
      'YE14': { ar: 'Ø§Ù„Ø¬ÙˆÙ', en: 'Al Jawf', capital_ar: 'Ø§Ù„Ø­Ø²Ù…', capital_en: 'Al Hazm' },
      'YE15': { ar: 'Ø§Ù„Ù…Ù‡Ø±Ø©', en: 'Al Mahrah', capital_ar: 'Ø§Ù„ØºÙŠØ¶Ø©', capital_en: 'Al Ghaydah' },
      'YE16': { ar: 'Ø§Ù„Ù…Ø­ÙˆÙŠØª', en: 'Al Mahwit', capital_ar: 'Ø§Ù„Ù…Ø­ÙˆÙŠØª', capital_en: 'Al Mahwit' },
      'YE17': { ar: 'Ø¹Ù…Ø±Ø§Ù†', en: 'Amran', capital_ar: 'Ø¹Ù…Ø±Ø§Ù†', capital_en: 'Amran' },
      'YE18': { ar: 'Ø§Ù„Ø¶Ø§Ù„Ø¹', en: 'Ad Dali', capital_ar: 'Ø§Ù„Ø¶Ø§Ù„Ø¹', capital_en: 'Ad Dali' },
      'YE19': { ar: 'Ø°Ù…Ø§Ø±', en: 'Dhamar', capital_ar: 'Ø°Ù…Ø§Ø±', capital_en: 'Dhamar' },
      'YE20': { ar: 'Ø­Ø¶Ø±Ù…ÙˆØª', en: 'Hadramawt', capital_ar: 'Ø§Ù„Ù…ÙƒÙ„Ø§', capital_en: 'Al Mukalla' },
      'YE21': { ar: 'Ø­Ø¬Ø©', en: 'Hajjah', capital_ar: 'Ø­Ø¬Ø©', capital_en: 'Hajjah' },
      'YE22': { ar: 'Ø¥Ø¨', en: 'Ibb', capital_ar: 'Ø¥Ø¨', capital_en: 'Ibb' },
      'YE23': { ar: 'Ù„Ø­Ø¬', en: 'Lahij', capital_ar: 'Ø§Ù„Ø­ÙˆØ·Ø©', capital_en: 'Al Houta' },
      'YE24': { ar: 'Ù…Ø£Ø±Ø¨', en: 'Marib', capital_ar: 'Ù…Ø£Ø±Ø¨', capital_en: 'Marib' },
      'YE25': { ar: 'Ø±ÙŠÙ…Ø©', en: 'Raymah', capital_ar: 'Ø§Ù„Ø¬Ø¨ÙŠÙ†', capital_en: 'Al Jabin' },
      'YE26': { ar: 'ØµØ¹Ø¯Ø©', en: 'Saada', capital_ar: 'ØµØ¹Ø¯Ø©', capital_en: 'Saada' },
      'YE27': { ar: 'ØµÙ†Ø¹Ø§Ø¡', en: 'Sanaa', capital_ar: 'ØµÙ†Ø¹Ø§Ø¡', capital_en: 'Sanaa' },
      'YE28': { ar: 'Ø´Ø¨ÙˆØ©', en: 'Shabwah', capital_ar: 'Ø¹ØªÙ‚', capital_en: 'Ataq' },
      'YE29': { ar: 'Ø³Ù‚Ø·Ø±Ù‰', en: 'Socotra', capital_ar: 'Ø­Ø¯ÙŠØ¨Ùˆ', capital_en: 'Hadibo' },
      'YE30': { ar: 'ØªØ¹Ø²', en: 'Taizz', capital_ar: 'ØªØ¹Ø²', capital_en: 'Taizz' },
      'YE31': { ar: 'Ø£Ø¨ÙŠÙ†', en: 'Abyan', capital_ar: 'Ø²Ù†Ø¬Ø¨Ø§Ø±', capital_en: 'Zinjibar' }
    };

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
    let governoratesImported = 0;
    for (const [code, data] of allGovernorates) {
      const govInfo = governorateNames[code] || { 
        ar: `Ù…Ø­Ø§ÙØ¸Ø© ${code}`, 
        en: `Governorate ${code}`, 
        capital_ar: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        capital_en: 'Not specified'
      };
      
      const result = await client.query(`
        INSERT INTO governorates (code, name_ar, name_en, capital_ar, capital_en, population)
        VALUES ($1, $2, $3, $4, $5, $6)
        ON CONFLICT (code) DO UPDATE SET 
          name_ar = EXCLUDED.name_ar,
          name_en = EXCLUDED.name_en,
          updated_at = NOW()
        RETURNING id, code, name_ar
      `, [code, govInfo.ar, govInfo.en, govInfo.capital_ar, govInfo.capital_en, (data.districtsCount + data.subDistrictsCount) * 15000]);
      
      if (result.rows.length > 0) {
        governoratesImported++;
        console.log(`   âœ… ${result.rows[0].name_ar} (${result.rows[0].code})`);
      }
    }
    
    console.log(`ðŸ›ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${governoratesImported} Ù…Ø­Ø§ÙØ¸Ø©`);

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª
    console.log('\nðŸ˜ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª...');
    let districtsImported = 0;
    
    for (const district of districtsData.districts) {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
      const governorateResult = await client.query('SELECT id FROM governorates WHERE code = $1', [district.governorateCode]);
      
      if (governorateResult.rows.length === 0) {
        console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­Ø§ÙØ¸Ø©: ${district.governorateCode} Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠØ© ${district.code}`);
        continue;
      }
      
      const result = await client.query(`
        INSERT INTO districts (code, governorate_id, name_ar, name_en, district_type, area_km2, geometry, bounds)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
        ON CONFLICT (code) DO UPDATE SET 
          name_ar = EXCLUDED.name_ar,
          name_en = EXCLUDED.name_en,
          area_km2 = EXCLUDED.area_km2,
          geometry = EXCLUDED.geometry,
          bounds = EXCLUDED.bounds,
          updated_at = NOW()
        RETURNING id, code, name_ar
      `, [
        district.code,
        governorateResult.rows[0].id,
        district.nameAr,
        district.nameEn,
        'Ù…Ø¯ÙŠØ±ÙŠØ©',
        district.area,
        JSON.stringify(district.geometry),
        district.bounds
      ]);
      
      if (result.rows.length > 0) {
        districtsImported++;
        if (districtsImported <= 10) {
          console.log(`   âœ… ${result.rows[0].name_ar} (${result.rows[0].code})`);
        }
      }
    }
    
    console.log(`ðŸ˜ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${districtsImported} Ù…Ø¯ÙŠØ±ÙŠØ©`);

    console.log('\nâœ… Ø§ÙƒØªÙ…Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
    console.log('ðŸ“Š Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ø²Ù„...');

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error.message);
    throw error;
  } finally {
    await client.end();
  }
}

importGeographicData().catch(console.error);