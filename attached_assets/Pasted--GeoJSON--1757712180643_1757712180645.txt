// ğŸ˜ï¸ Ø£Ø¯Ø§Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø§Ù„ÙŠÙ…Ù†ÙŠØ©
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ù…Ù„Ù GeoJSON Ø§Ù„Ù…Ø±ÙÙ‚

import fs from 'fs';
import path from 'path';

console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø§Ù„ÙŠÙ…Ù†ÙŠØ©...');

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª
const districtsFile = 'attached_assets/dis_1757518247340.geojson';

if (!fs.existsSync(districtsFile)) {
  console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª:', districtsFile);
  process.exit(1);
}

console.log('ğŸ“‚ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª:', districtsFile);

try {
  const fileContent = fs.readFileSync(districtsFile, 'utf8');
  const geoJsonData = JSON.parse(fileContent);
  
  if (geoJsonData.type !== 'FeatureCollection' || !Array.isArray(geoJsonData.features)) {
    console.error('âŒ ØªÙ†Ø³ÙŠÙ‚ GeoJSON ØºÙŠØ± ØµØ­ÙŠØ­');
    process.exit(1);
  }
  
  console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù: ${geoJsonData.features.length}`);
  
  // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  console.log('\nğŸ“‹ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
  
  const governoratesMap = new Map();
  const sampleData = [];
  
  geoJsonData.features.slice(0, 10).forEach((feature, index) => {
    const props = feature.properties;
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
    if (props.admin1Pcod && !governoratesMap.has(props.admin1Pcod)) {
      governoratesMap.set(props.admin1Pcod, {
        code: props.admin1Pcod,
        count: 0
      });
    }
    
    if (props.admin1Pcod) {
      governoratesMap.get(props.admin1Pcod).count++;
    }
    
    // Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (index < 5) {
      sampleData.push({
        districtCode: props.admin2Pcod,
        districtNameAr: props.admin2Na_1 || props.admin2Name,
        districtNameEn: props.admin2Name,
        governorateCode: props.admin1Pcod,
        hasGeometry: feature.geometry ? true : false,
        geometryType: feature.geometry?.type
      });
    }
  });
  
  console.log(`\nğŸ›ï¸ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${governoratesMap.size}`);
  console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª:');
  
  Array.from(governoratesMap.entries())
    .sort((a, b) => b[1].count - a[1].count)
    .slice(0, 10)
    .forEach(([code, data]) => {
      console.log(`   ${code}: ${data.count} Ù…Ø¯ÙŠØ±ÙŠØ©`);
    });
  
  console.log('\nğŸ“ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª (Ø£ÙˆÙ„ 5):');
  sampleData.forEach((district, index) => {
    console.log(`${index + 1}. ${district.districtNameAr} (${district.districtCode})`);
    console.log(`   Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${district.governorateCode}`);
    console.log(`   Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ: ${district.districtNameEn}`);
    console.log(`   Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${district.hasGeometry ? 'âœ…' : 'âŒ'} (${district.geometryType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'})`);
    console.log('');
  });
  
  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
  const featuresWithGeometry = geoJsonData.features.filter(f => f.geometry).length;
  const featuresWithoutGeometry = geoJsonData.features.length - featuresWithGeometry;
  
  console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©:');
  console.log(`   - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª: ${geoJsonData.features.length}`);
  console.log(`   - Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø¨Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${featuresWithGeometry}`);
  console.log(`   - Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${featuresWithoutGeometry}`);
  console.log(`   - Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${governoratesMap.size}`);
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  const processedData = {
    type: 'ProcessedGeoData',
    source: 'dis_1757518247340.geojson',
    processedAt: new Date().toISOString(),
    statistics: {
      totalDistricts: geoJsonData.features.length,
      districtsWithGeometry: featuresWithGeometry,
      districtsWithoutGeometry: featuresWithoutGeometry,
      governoratesCount: governoratesMap.size
    },
    governorates: Array.from(governoratesMap.entries()).map(([code, data]) => ({
      code,
      districtsCount: data.count
    })),
    sampleDistricts: sampleData,
    districts: geoJsonData.features.map(feature => ({
      code: feature.properties.admin2Pcod,
      nameAr: feature.properties.admin2Na_1 || feature.properties.admin2Name,
      nameEn: feature.properties.admin2Name,
      governorateCode: feature.properties.admin1Pcod,
      geometry: feature.geometry,
      bounds: calculateBounds(feature.geometry)
    }))
  };
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  const outputFile = 'processed_districts_data.json';
  fs.writeFileSync(outputFile, JSON.stringify(processedData, null, 2));
  console.log(`\nğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠ: ${outputFile}`);
  
  console.log('\nâœ… Ø§ÙƒØªÙ…Ù„ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!');
  
} catch (error) {
  console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error.message);
  process.exit(1);
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©
function calculateBounds(geometry) {
  if (!geometry || !geometry.coordinates) return null;

  let minLng = Infinity, minLat = Infinity;
  let maxLng = -Infinity, maxLat = -Infinity;

  const processCoords = (coords) => {
    if (Array.isArray(coords[0])) {
      coords.forEach(processCoords);
    } else {
      const [lng, lat] = coords;
      minLng = Math.min(minLng, lng);
      maxLng = Math.max(maxLng, lng);
      minLat = Math.min(minLat, lat);
      maxLat = Math.max(maxLat, lat);
    }
  };

  processCoords(geometry.coordinates);
  return [minLng, minLat, maxLng, maxLat];
}