// ğŸ¡ Ø£Ø¯Ø§Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ù„Ù„Ø¹Ø²Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠØ©
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ù…Ù„Ù GeoJSON Ø§Ù„Ù…Ø±ÙÙ‚

import fs from 'fs';
import path from 'path';

console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø²Ù„ Ø§Ù„ÙŠÙ…Ù†ÙŠØ©...');

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¹Ø²Ù„
const subDistrictsFile = 'attached_assets/azal_1757518247339.geojson';

if (!fs.existsSync(subDistrictsFile)) {
  console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¹Ø²Ù„:', subDistrictsFile);
  process.exit(1);
}

console.log('ğŸ“‚ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¹Ø²Ù„:', subDistrictsFile);

try {
  const fileContent = fs.readFileSync(subDistrictsFile, 'utf8');
  const geoJsonData = JSON.parse(fileContent);
  
  if (geoJsonData.type !== 'FeatureCollection' || !Array.isArray(geoJsonData.features)) {
    console.error('âŒ ØªÙ†Ø³ÙŠÙ‚ GeoJSON ØºÙŠØ± ØµØ­ÙŠØ­');
    process.exit(1);
  }
  
  console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø²Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ù: ${geoJsonData.features.length}`);
  
  // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  console.log('\nğŸ“‹ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
  
  const governoratesMap = new Map();
  const districtsMap = new Map();
  const sampleData = [];
  
  geoJsonData.features.slice(0, 20).forEach((feature, index) => {
    const props = feature.properties;
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
    if (props.admin1Pcod && !governoratesMap.has(props.admin1Pcod)) {
      governoratesMap.set(props.admin1Pcod, {
        code: props.admin1Pcod,
        count: 0
      });
    }
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª
    if (props.admin2Pcod && !districtsMap.has(props.admin2Pcod)) {
      districtsMap.set(props.admin2Pcod, {
        code: props.admin2Pcod,
        governorateCode: props.admin1Pcod,
        count: 0
      });
    }
    
    if (props.admin1Pcod) {
      governoratesMap.get(props.admin1Pcod).count++;
    }
    
    if (props.admin2Pcod) {
      districtsMap.get(props.admin2Pcod).count++;
    }
    
    // Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (index < 8) {
      sampleData.push({
        subDistrictCode: props.admin3Pcod,
        subDistrictNameAr: props.admin3Na_1 || props.admin3Name,
        subDistrictNameEn: props.admin3Name,
        districtCode: props.admin2Pcod,
        governorateCode: props.admin1Pcod,
        hasGeometry: feature.geometry ? true : false,
        geometryType: feature.geometry?.type,
        lng: props.lang,
        lat: props.lat
      });
    }
  });
  
  console.log(`\nğŸ›ï¸ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${governoratesMap.size}`);
  console.log('ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª:');
  
  Array.from(governoratesMap.entries())
    .sort((a, b) => b[1].count - a[1].count)
    .slice(0, 10)
    .forEach(([code, data]) => {
      console.log(`   ${code}: ${data.count} Ø¹Ø²Ù„Ø©`);
    });
  
  console.log(`\nğŸ˜ï¸ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${districtsMap.size}`);
  console.log('ğŸ“‹ Ø£Ù‡Ù… Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª (Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø²Ù„):');
  
  Array.from(districtsMap.entries())
    .sort((a, b) => b[1].count - a[1].count)
    .slice(0, 10)
    .forEach(([code, data]) => {
      console.log(`   ${code} (${data.governorateCode}): ${data.count} Ø¹Ø²Ù„Ø©`);
    });
  
  console.log('\nğŸ“ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø²Ù„ (Ø£ÙˆÙ„ 8):');
  sampleData.forEach((subDistrict, index) => {
    console.log(`${index + 1}. ${subDistrict.subDistrictNameAr} (${subDistrict.subDistrictCode})`);
    console.log(`   Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©: ${subDistrict.districtCode}`);
    console.log(`   Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${subDistrict.governorateCode}`);
    console.log(`   Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ: ${subDistrict.subDistrictNameEn}`);
    console.log(`   Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${subDistrict.hasGeometry ? 'âœ…' : 'âŒ'} (${subDistrict.geometryType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'})`);
    console.log(`   Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${subDistrict.lng}, ${subDistrict.lat}`);
    console.log('');
  });
  
  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
  const featuresWithGeometry = geoJsonData.features.filter(f => f.geometry).length;
  const featuresWithoutGeometry = geoJsonData.features.length - featuresWithGeometry;
  
  // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø²Ù„ ÙˆØ§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª
  const districtSubDistrictRelation = {};
  geoJsonData.features.forEach(feature => {
    const props = feature.properties;
    if (props.admin2Pcod && props.admin3Pcod) {
      if (!districtSubDistrictRelation[props.admin2Pcod]) {
        districtSubDistrictRelation[props.admin2Pcod] = [];
      }
      districtSubDistrictRelation[props.admin2Pcod].push({
        code: props.admin3Pcod,
        nameAr: props.admin3Na_1 || props.admin3Name,
        nameEn: props.admin3Name
      });
    }
  });
  
  console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©:');
  console.log(`   - Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø²Ù„: ${geoJsonData.features.length}`);
  console.log(`   - Ø¹Ø²Ù„ Ø¨Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${featuresWithGeometry}`);
  console.log(`   - Ø¹Ø²Ù„ Ø¨Ø¯ÙˆÙ† Ù‡Ù†Ø¯Ø³Ø© Ø¬ØºØ±Ø§ÙÙŠØ©: ${featuresWithoutGeometry}`);
  console.log(`   - Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${governoratesMap.size}`);
  console.log(`   - Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${districtsMap.size}`);
  console.log(`   - Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø±Ø¨Ø·: ${Object.keys(districtSubDistrictRelation).length} Ù…Ø¯ÙŠØ±ÙŠØ© Ù…Ø±ØªØ¨Ø·Ø©`);
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  const processedData = {
    type: 'ProcessedSubDistrictsGeoData',
    source: 'azal_1757518247339.geojson',
    processedAt: new Date().toISOString(),
    statistics: {
      totalSubDistricts: geoJsonData.features.length,
      subDistrictsWithGeometry: featuresWithGeometry,
      subDistrictsWithoutGeometry: featuresWithoutGeometry,
      governoratesCount: governoratesMap.size,
      districtsCount: districtsMap.size,
      connectedDistricts: Object.keys(districtSubDistrictRelation).length
    },
    governorates: Array.from(governoratesMap.entries()).map(([code, data]) => ({
      code,
      subDistrictsCount: data.count
    })),
    districts: Array.from(districtsMap.entries()).map(([code, data]) => ({
      code,
      governorateCode: data.governorateCode,
      subDistrictsCount: data.count
    })),
    districtSubDistrictRelations: districtSubDistrictRelation,
    sampleSubDistricts: sampleData,
    subDistricts: geoJsonData.features.map(feature => ({
      code: feature.properties.admin3Pcod,
      nameAr: feature.properties.admin3Na_1 || feature.properties.admin3Name,
      nameEn: feature.properties.admin3Name,
      districtCode: feature.properties.admin2Pcod,
      governorateCode: feature.properties.admin1Pcod,
      coordinates: {
        lng: parseFloat(feature.properties.lang),
        lat: parseFloat(feature.properties.lat)
      },
      geometry: feature.geometry,
      bounds: calculateBounds(feature.geometry)
    }))
  };
  
  // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  const outputFile = 'processed_sub_districts_data.json';
  fs.writeFileSync(outputFile, JSON.stringify(processedData, null, 2));
  console.log(`\nğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠ: ${outputFile}`);
  
  console.log('\nâœ… Ø§ÙƒØªÙ…Ù„ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø²Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
  
} catch (error) {
  console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error.message);
  process.exit(1);
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©
function calculateBounds(geometry) {
  if (!geometry || !geometry.coordinates) return null;

  let minLng = Infinity, minLat = Infinity;
  let maxLng = -Infinity, maxLat = -Infinity;

  const processCoords = (coords) => {
    if (Array.isArray(coords[0])) {
      coords.forEach(processCoords);
    } else {
      const [lng, lat] = coords;
      minLng = Math.min(minLng, lng);
      maxLng = Math.max(maxLng, lng);
      minLat = Math.min(minLat, lat);
      maxLat = Math.max(maxLat, lat);
    }
  };

  processCoords(geometry.coordinates);
  return [minLng, minLat, maxLng, maxLat];
}