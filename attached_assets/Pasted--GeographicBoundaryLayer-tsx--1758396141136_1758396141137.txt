المهمة: تحليل وإصلاح أخطاء في ملف واجهة عرض الخرائط (GeographicBoundaryLayer.tsx).
الملف المطلوب تعديله:
./client/src/components/gis/GeographicBoundaryLayer.tsx
تحليل الأخطاء المكتشفة:
بعد مراجعة الكود الحالي، تم تحديد ثلاثة أخطاء رئيسية تمنع الواجهة من العمل بشكل صحيح:
خطأ في منطق جلب القطاعات (Sectors): الكود الحالي يقوم بطلب بيانات القطاعات باستخدام governorateId (معرف المحافظة). هذا خطأ، حيث يجب أن يتم جلب القطاعات التابعة لـ districtId (معرف المديرية) المحدد. هذا هو سبب ظهور قطاعات المحافظة بأكملها بدلاً من تلك المرتبطة بالمديرية المختارة.
خطأ في معالجة أسماء الأعمدة (Column Mapping): الكود يفترض أن البيانات القادمة من الـ API لجميع المستويات (عزل، قطاعات، أحياء) تحتوي على حقلي id و nameAr. هذا الافتراض غير صحيح. البيانات الفعلية تستخدم أسماء أعمدة مختلفة (مثل admin3Na_1 للعزل و Zone_ للقطاعات). نتيجة لذلك، يفشل الكود في العثور على أسماء هذه المناطق الجغرافية، مما يؤدي إلى عدم عرضها على الخريطة.
صيغة غير مثالية لمفاتيح الاستعلام (Query Keys): يتم دمج معاملات الطلب (مثل districtId) مباشرة في السلسلة النصية لمفتاح الاستعلام (queryKey). هذه الطريقة تعمل، لكنها ليست الأفضل وتخالف الممارسات الموصى بها في مكتبة react-query، مما قد يؤثر على كفاءة التخزين المؤقت للبيانات (caching).
التغييرات المطلوبة (الحل):
لتصحيح هذه الأخطاء، قم بتنفيذ التعديلات التالية في الملف المذكور:
تصحيح استعلام القطاعات: قم بتغيير استعلام useQuery الخاص بالقطاعات ليعتمد على selectedDistrictId بدلاً من selectedGovernorateId.
تطبيق تحويل البيانات (Data Transformation): داخل كل استعلام useQuery للمستويات الإدارية التي بها مشكلة (العزل، القطاعات، الأحياء)، استخدم الخيار select لتحويل البيانات المستلمة فورًا إلى البنية الموحدة التي يفهمها باقي المكون. يجب أن تقوم دالة select بتحويل كل عنصر إلى كائن بالصيغة: { id: string, nameAr: string, geometry: any }.
للعزل (Sub-districts): استخرج id من admin3Pcod و nameAr من admin3Na_1.
للقطاعات (Sectors): استخرج id و nameAr من Zone_.
للوحدات السكنية (Neighborhoods): استخرج id و nameAr من ÑÞã_æÍÏÉ_Ç.
تحسين صيغة مفاتيح الاستعلام: قم بفصل معاملات الطلب عن عنوان الـ API في queryKey. على سبيل المثال، غير ['/api/sectors?districtId=...'] إلى ['/api/sectors', { districtId: ... }].
الهدف النهائي: بعد تطبيق هذه الإصلاحات، يجب أن تعمل الخريطة بشكل هرمي وصحيح، حيث تظهر العزل والقطاعات عند اختيار المديرية المناسبة.
